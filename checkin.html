<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EARO - Daily Check-in</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #8B5CF6, #7C3AED);
            --secondary-gradient: linear-gradient(135deg, #C4B5FD, #A78BFA);
            --light-bg: linear-gradient(135deg, #F6F3FF, #EDE7F6);
            --dark-bg: linear-gradient(135deg, #1A1A1A, #2E2A36);
            --card-light: rgba(255, 255, 255, 0.7);
            --card-dark: rgba(255, 255, 255, 0.1);
            --text-light: #333;
            --text-dark: #F5F5F5;
            --shadow-light: 0 8px 25px rgba(0,0,0,0.15);
            --shadow-dark: 0 8px 25px rgba(0,0,0,0.4);
            --accent: #8B5CF6;
        }
        
        body {
            background: var(--light-bg);
            color: var(--text-light);
            transition: all 0.5s ease;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--text-dark);
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .dark-mode .back-btn {
            color: var(--text-dark);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .checkin-card {
            background: var(--card-light);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 40px 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dark-mode .checkin-card {
            background: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }
        
        .checkin-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .checkin-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .checkin-desc {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        .checkin-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .checkin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .checkin-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .reward-amount {
            font-size: 32px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 20px 0;
        }
        
        .streak-card {
            background: var(--card-light);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }
        
        .dark-mode .streak-card {
            background: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }
        
        .streak-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .streak-days {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .streak-day {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-light);
            border: 2px solid var(--accent);
            font-weight: 600;
        }
        
        .dark-mode .streak-day {
            background: var(--card-dark);
        }
        
        .streak-day.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }
        
        .streak-day.completed {
            background: var(--accent);
            color: white;
            border-color: transparent;
        }
        
        .history-card {
            background: var(--card-light);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark-mode .history-card {
            background: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }
        
        .history-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .dark-mode .history-item {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-size: 14px;
        }
        
        .history-amount {
            font-weight: 600;
            color: var(--accent);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-light);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .dark-mode .bottom-nav {
            background: var(--card-dark);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .dark-mode .nav-item {
            color: var(--text-dark);
        }
        
        .nav-item.active {
            color: var(--accent);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent);
            top: -10px;
            opacity: 0;
            z-index: 1000;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        
        .success {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .error {
            background: rgba(231, 76, 60, 0.2);
            color: #c0392b;
            border: 1px solid #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê</button>
            <div class="logo">EARO</div>
            <div style="width: 24px;"></div>
        </div>
        
        <div class="page-title">Daily Check-in</div>
        
        <!-- Check-in Card -->
        <div class="checkin-card">
            <div class="checkin-icon">üìÖ</div>
            <div class="checkin-title">Daily Reward</div>
            <div class="checkin-desc">Check in daily to earn rewards</div>
            
            <div id="rewardDisplay" style="display: none;">
                <div>You earned:</div>
                <div class="reward-amount" id="rewardAmount">‚Çπ0</div>
            </div>
            
            <button class="checkin-btn" id="checkinBtn">Check In Today</button>
        </div>
        
        <!-- Message Display -->
        <div class="message success" id="successMessage"></div>
        <div class="message error" id="errorMessage"></div>
        
        <!-- Streak Card -->
        <div class="streak-card">
            <div class="streak-title">Your Check-in Streak</div>
            <div class="streak-days" id="streakDays">
                <!-- Streak days will be populated by JavaScript -->
            </div>
            <div style="text-align: center; font-size: 14px; opacity: 0.8;">
                Streak: <span id="currentStreak">0</span> days
            </div>
        </div>
        
        <!-- History Card -->
        <div class="history-card">
            <div class="history-title">Recent Check-ins</div>
            <div id="checkinHistory">
                <!-- Check-in history will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </a>
        <a href="tasks.html" class="nav-item">
            <div class="nav-icon">üìã</div>
            <div>Tasks</div>
        </a>
        <a href="checkin.html" class="nav-item active">
            <div class="nav-icon">‚úÖ</div>
            <div>Check-in</div>
        </a>
        <a href="withdraw.html" class="nav-item">
            <div class="nav-icon">üí∏</div>
            <div>Withdraw</div>
        </a>
        <a href="profile.html" class="nav-item">
            <div class="nav-icon">üë§</div>
            <div>Profile</div>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://yxzztomtgaqmboquoszg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4enp0b210Z2FxbWJvcXVvc3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzU4OTQsImV4cCI6MjA3ODAxMTg5NH0.NKaBpeTUE3zgcyCOl_mbF1NJHGry5I8vBDzkb1RS1DY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let todayCheckedIn = false;

        // Check authentication
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
            loadCheckinStatus();
            loadCheckinHistory();
        });

        // Load check-in status
        async function loadCheckinStatus() {
            // Check if user already checked in today
            const today = new Date().toISOString().split('T')[0];
            
            const { data: checkin, error } = await supabase
                .from('checkins')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', today)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Error loading check-in status:', error);
                return;
            }

            todayCheckedIn = !!checkin;
            
            if (todayCheckedIn) {
                document.getElementById('checkinBtn').disabled = true;
                document.getElementById('checkinBtn').textContent = 'Already Checked In';
                document.getElementById('rewardDisplay').style.display = 'block';
                document.getElementById('rewardAmount').textContent = '‚Çπ' + checkin.reward;
            }

            loadStreak();
        }

        // Load streak data
        async function loadStreak() {
            // Get last 7 days of check-ins
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
            sevenDaysAgo.setHours(0, 0, 0, 0);

            const { data: checkins, error } = await supabase
                .from('checkins')
                .select('date')
                .eq('user_id', currentUser.id)
                .gte('date', sevenDaysAgo.toISOString().split('T')[0])
                .order('date', { ascending: true });

            if (error) {
                console.error('Error loading streak:', error);
                return;
            }

            const checkinDates = checkins.map(c => c.date);
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate current streak
            let streak = 0;
            let currentDate = new Date(today);
            
            while (true) {
                const dateStr = currentDate.toISOString().split('T')[0];
                if (checkinDates.includes(dateStr)) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }

            document.getElementById('currentStreak').textContent = streak;

            // Display last 7 days
            const streakDaysContainer = document.getElementById('streakDays');
            let html = '';
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en', { weekday: 'short' });
                const isChecked = checkinDates.includes(dateStr);
                const isToday = dateStr === today;
                
                html += `
                    <div class="streak-day ${isChecked ? 'completed' : ''} ${isToday ? 'active' : ''}">
                        ${dayName.charAt(0)}
                    </div>
                `;
            }
            
            streakDaysContainer.innerHTML = html;
        }

        // Load check-in history
        async function loadCheckinHistory() {
            const { data: checkins, error } = await supabase
                .from('checkins')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(10);

            if (error) {
                console.error('Error loading check-in history:', error);
                return;
            }

            const historyContainer = document.getElementById('checkinHistory');
            
            if (checkins.length === 0) {
                historyContainer.innerHTML = '<div style="text-align: center; opacity: 0.7;">No check-in history</div>';
                return;
            }

            historyContainer.innerHTML = checkins.map(checkin => `
                <div class="history-item">
                    <div class="history-date">${formatDate(checkin.date)}</div>
                    <div class="history-amount">+‚Çπ${checkin.reward}</div>
                </div>
            `).join('');
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { 
                day: 'numeric', 
                month: 'short',
                year: 'numeric'
            });
        }

        // Check-in button handler
        document.getElementById('checkinBtn').addEventListener('click', async function() {
            if (todayCheckedIn) return;

            const button = this;
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                // Generate random reward between ‚Çπ2 and ‚Çπ10
                const reward = Math.floor(Math.random() * 9) + 2;
                const today = new Date().toISOString().split('T')[0];

                // Record check-in
                const { error: checkinError } = await supabase
                    .from('checkins')
                    .insert([
                        {
                            user_id: currentUser.id,
                            date: today,
                            reward: reward
                        }
                    ]);

                if (checkinError) throw checkinError;

                // Update user wallet
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('wallet, total_earned')
                    .eq('id', currentUser.id)
                    .single();

                if (userError) throw userError;

                const newWallet = user.wallet + reward;
                const newTotal = user.total_earned + reward;

                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        wallet: newWallet,
                        total_earned: newTotal
                    })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                // Record transaction
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            user_id: currentUser.id,
                            amount: reward,
                            type: 'credit',
                            reason: 'Daily Check-in',
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (transactionError) throw transactionError;

                // Show success
                document.getElementById('rewardAmount').textContent = '‚Çπ' + reward;
                document.getElementById('rewardDisplay').style.display = 'block';
                document.getElementById('successMessage').textContent = `Success! You earned ‚Çπ${reward} from daily check-in.`;
                document.getElementById('successMessage').style.display = 'block';
                
                button.textContent = 'Already Checked In';
                todayCheckedIn = true;

                // Show confetti
                createConfetti();

                // Reload streak and history
                loadStreak();
                loadCheckinHistory();

            } catch (error) {
                console.error('Error during check-in:', error);
                document.getElementById('errorMessage').textContent = 'Error processing check-in. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
                button.disabled = false;
                button.textContent = 'Check In Today';
            }
        });

        // Confetti animation
        function createConfetti() {
            const colors = ['#8B5CF6', '#7C3AED', '#C4B5FD', '#A78BFA', '#F59E0B'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.animation = `confetti ${Math.random() * 3 + 2}s linear forwards`;
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
    </script>
</body>
</html>
